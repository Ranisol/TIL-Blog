---
title: (Nodejs) 4. 서버와의 통신
date: "2020-09-20"
description: 
---

# 1. 요청과 응답
클라이언트의 요청: 
- 주로 요청하는 주체를 Client라고 지칭함. 일반적으로 **http(url)**를 이용해서 요청하게 됨. 

서버의 응답: 
- Client가 요청하고, Server가 응답하는 형태. 다양한 형태로 받을 수 있음(JSON, HTML, plain text등). 서버가 요청을 받고, 서버는 응답하는 과정에서 **API**를 사용.

즉, 데이터를 요청할 때는 http와 api에 따른 규약에 맞춰서 요청을 수행해야 한다.


## 1.1 HTTP
HperText Transfer **Protocol**
- 프로토콜은 규약, 규칙을 의미한다. 

작동방식: 서버 클라이언트 주고받음
구성
- 헤더: origin / content type / user agent
- 바디
속성
- stateless: 각 요청은 모두 독립적이라는 뜻. 즉, 두번째 요청을 보낸다고 해서, 내가 두번째 보내는 요청인지 서버는 알 수 없음
- connectionless: 한번의 요청에는 한번의 응답. 응답 이후에는 연결이 끊김
  - 이를 해결하기 위해서
메소드
- Get: 자원 요청
- post: 서버에 자원 생성(메세지 처음 쓸 때)
- put: 서버에 자원 수정
- delete: 서버 자원 제거

## 1.2 API
**API란?**
- 특정 요청에 대한 특정 응답을 형식화 해놓은 Interface이다. 응답이 정형화 되어 있기 때문에 클라이언트는 응답을 예상하고 요청을 할 수 있다. 
- 실생활에서 이와 같은 예로, 메뉴판이 있다. 구매자는 어떤 요청을 하면, 판매자가 어떤 물건을 가져다 줄지를 알고 메뉴를 선택할 수 있고, 판매자는 요청이 들어오면 즉각적으로 물건을 만들어 건네줄 수 있다.

그렇다면 이러한 방식의 요청은 **어떻게 이루어지는지?**
- 클라이언트는 Post를 통해 요청에 대한 내용을 작성할 수 있고, Get이라는 키워드로 메세지를 전달할 수 있다.
- 요청을 하려면 Get은 항상 필요하다. 하지만 Post는 항상 필요하지는 않다. 만일 가게에서 하나의 상품만 판매한다면, '주세요'라고만 말해도 가게 주인은 이 말을 알아듣고 상품을 제공할 수 있는 것과 같은 개념이다.


# 2. AJAX(Async Js  And Xml)
**AJAX의 이전**
- form태그를 이용해 페이지 전환과 요청에 따른 응답이 이루어짐. 이렇게 하게 되면, 페이지 전환시 페이지 전부를 로딩해야 하므로 문제가 느리다.

**AJAX = 자바스크립트를 이용한 서버와의 통신**
- 페이지의 일부만을 위한 데이터를 로드한다. (여기서 페이지 전체를 로드하지 않고, 필요한 일부 데이터만을 불러오기 위해 비동기(Async)방식이 사용된다.) 이렇게 하면, 서버와 자유롭게 통
- 이 과정에서 브라우저가 가지고 있는 XMLHttpRequest객체를 이용함. 이 객체를 통해 클라이언트와 서버간에 XML데이터를 주고받는다. 
- 또한 주고받은 데이터를 바탕으로 javascript와 dom을 이용해 웹페이지상의 일부분을 변경할 수 있다.

## 2.1 XMLHttpRequest & JQuery AJAX
**Using XMLHttpRequest**: XHLHttpRequest객체를 이용해 데이터를 주고 받는 방식
```js
var xhr = new XHLHttpRequest();
xhr.open('get', 'http...');
xhr.onreadystatechange = () =>  { // 요청의 상태 변화를 추적함
  if(xhr.readyState !== 4) return; 
  if(xhr.status === 200){
    console.log(xhr,responseText);
  }else{
    console.log('error' + xhr.status);
  }
}
xhr.send(); // 요청 전송
```
**jquery를 이용**해 요청을 주고받기도 함.
```js
 
```

하지만 복잡해: 좀 더 쓰기 쉬운 표준 API
- 이러한 AJAX를 좀 더 간편하게 구현하기 위해 javascript에서는 내장 라이브러리인 **fetch api** 또는 **axios**를 사용할 수 있다.


## 2.2 fetch 방식
XMLHttpRequest와 **뭐가 다른지?**


fetch는 주소를 받아오면 **promise객체를 생성**함. 따라서 다음과 같이 then catch를 사용할 수 있다.
```js
fetch('http://서버주소/weather?q=Seoul')  // url로 get 요청
.then(function(resp) {
  return resp.json(); // 응답: 응답 형식에 따라 resp.text() 가 될 수도 있다
})
.then(function(json) {
  console.log(json); // { tempature: 27 }
});
```



## 2.3 axios 방식

### (1) 서버로 요청을 보내기
- HTML아래 스크립트를 추가해 사용 가능.

- axios.get함수의 인수로 요청을 보낼 주소를 넣음

```js
axios.get('http...')
  .then(result) => {
    ...
  }
  .catch(error) => {
    ...
  }
```

### (2) async, await을 이용하기?
- 이건 promise를 지원하는지 안하는지 확인해야함. 이건 알아보고 사용해야함
- axios.get은 지원하는데, 아래와 같이 사용할 수 있음.

```js
async () => {
  try{
    const result = await axios.get('http...')
  }
}catch(error){
  ...
}
```
### (3) axios.get vs axios.post
- post는 데이터를 담아 서버로 보내는게 가능하다. 데이터를 담아 서버로 보낼 때에는, post의 두번째 인자로 보낼 데이터를 넣어주면 된다.

```js
let data = {name:'hlel'}
axios.post('http...', data)
```

# 3. 서버 요청시, 다양한 이슈 처리하기


## 3.1 API 예제
- 날씨 api:  https://openweathermap.org/API
- 다양한 api https://www.apistore.co.kr


## 3.2 FormData(데이터 전달)
- HTML의 form태그에 담긴 데이터를 ajax요청으로 보내고 싶은 경우가 있음.
이 때, formData객체를 이용하는게 가능. 
- formData에는 다음과 같은 메서드가 있음
  - append: 데이터를 하나씩 추가
  - has로 데이터 존재 여부 확인, get으로 조회, getAll로 모두 조회
  - set으로 데이터 수정
  - delete로 데이터 삭제

```js
const formData = new FormData()
formData.appned('a','b');
```

## 3.3 주소창에 한글 보내고 가져오는 경우
- 서버가 처리를 하지 못하는 경우가 종종 발생한다.
- 이럴때, encodeURLComponent, decodeURLComponent로 한글을 감싸, 처리할 수 있다.

```js
const result = await axios.get(`http.../${encodeURLComponent('노드')}`)
```

- 또한, 이렇게 보낸 인코딩 된 url를 다시 받아올때는 decodeURLComponent로 감싸서 가져옴.

## 3.4 HTML태그에 데이터를 저장
이거는 Twittler하면서 사용해봤던 것 같은데, HTML태그에 데이터를 저장하는 방식이다. 
- 'data-속성명'을 통해 태그 내 저장이 가능하다. 
- 그리고 여기에 접근하려면, dataset이라는 속성명을 통해 접근 가능하다.
- 반대로 자바스크립트 dataset에 값을 넣게 되면, data-속성이 생긴다.
- 이러한 방식의 단점은?
  - html태그에 보여지기 때문에, 누구나 접근이 가능하다는 점.

```js
<li data-id='1' data-user-job="programmer">a</li>
```

```js
<marquee> 우와앙 </marquee>
   

```